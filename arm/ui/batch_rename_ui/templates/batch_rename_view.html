{% extends "base.html" %}

{% block content %}
<style>
    .batch-job-card {
        transition: all 0.2s;
        cursor: pointer;
        border: 2px solid transparent;
    }
    .batch-job-card.selected {
        border: 2px solid #ffc107;
        background-color: rgba(255, 193, 7, 0.1);
    }
    .batch-job-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .batch-checkbox {
        transform: scale(1.5);
        cursor: pointer;
    }
    .poster-container {
        position: relative;
        width: 100%;
        padding-top: 150%; /* 2:3 aspect ratio */
        overflow: hidden;
    }
    .poster-container img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .selection-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        font-size: 1.5rem;
        z-index: 10;
    }
    .batch-toolbar {
        position: sticky;
        top: 60px;
        z-index: 100;
        background: white;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .dark-mode .batch-toolbar {
        background: #1a1a1a;
    }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col-12 text-center">
            <img src="static/img/arm80.png" alt="Automatic Ripping Machine">
            <h3 class="mt-3"><strong>Batch Rename - Completed Discs</strong></h3>
            <p class="text-muted">Select multiple discs to batch rename with series names and disc labels</p>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="batch-toolbar rounded">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-0">
                    <span id="selection-count">0</span> disc(s) selected
                </h5>
            </div>
            <div class="col-md-6 text-right">
                <button id="select-all-btn" type="button" class="btn btn-info">
                    <i class="fa fa-check-square"></i> Select All
                </button>
                <button id="deselect-all-btn" type="button" class="btn btn-secondary">
                    <i class="fa fa-square"></i> Deselect All
                </button>
                <button id="filter-series-btn" type="button" class="btn btn-primary">
                    <i class="fa fa-filter"></i> TV Series Only
                </button>
                <button id="batch-rename-btn" type="button" class="btn btn-warning btn-lg" disabled>
                    <i class="fa fa-edit"></i> Batch Rename Selected
                </button>
            </div>
        </div>
    </div>

    <!-- Grid View -->
    <div class="row" id="jobs-grid">
        {% for job in jobs %}
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-4 job-grid-item" 
             data-video-type="{{ job.video_type }}"
             data-job-id="{{ job.job_id }}">
            <div class="card batch-job-card h-100" data-job-id="{{ job.job_id }}">
                <!-- Checkbox Badge -->
                <div class="selection-badge">
                    <input type="checkbox" class="batch-checkbox" 
                           data-job-id="{{ job.job_id }}"
                           data-video-type="{{ job.video_type }}"
                           data-status="{{ job.status }}">
                </div>
                
                <!-- Poster Image -->
                <div class="poster-container">
                    {% if not job.poster_url or job.poster_url == "None" %}
                        {% if job.video_type == "Music" %}
                            <img src="static/img/music.png" alt="No Poster">
                        {% else %}
                            <img src="static/img/none.png" alt="No Poster">
                        {% endif %}
                    {% else %}
                        <img src="{{ job.poster_url }}" alt="Poster">
                    {% endif %}
                </div>
                
                <!-- Card Body -->
                <div class="card-body p-2">
                    <h6 class="card-title mb-1" title="{{ job.title }}">
                        {% if job.title_manual %}
                            {{ job.title_manual[:30] }}{{ '...' if job.title_manual|length > 30 }}
                        {% else %}
                            {{ job.title[:30] }}{{ '...' if job.title|length > 30 }}
                        {% endif %}
                    </h6>
                    
                    <div class="small text-muted">
                        {% if job.year and job.year != '0000' and job.year != '' %}
                            <div><strong>Year:</strong> {{ job.year }}</div>
                        {% endif %}
                        
                        <div><strong>Type:</strong> 
                            {% if job.video_type == 'series' %}
                                <span class="badge badge-success">TV Series</span>
                            {% elif job.video_type == 'movie' %}
                                <span class="badge badge-primary">Movie</span>
                            {% else %}
                                <span class="badge badge-secondary">{{ job.video_type }}</span>
                            {% endif %}
                        </div>
                        
                        {% if job.label %}
                            <div><strong>Label:</strong> {{ job.label[:20] }}{{ '...' if job.label|length > 20 }}</div>
                        {% endif %}
                        
                        <div><strong>Started:</strong> {{ job.start_time.strftime('%m/%d %H:%M') if job.start_time }}</div>
                        
                        <div class="mt-2">
                            <a href="jobdetail?job_id={{ job.job_id }}" class="btn btn-sm btn-outline-primary btn-block">
                                <i class="fa fa-info-circle"></i> Details
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    {% if not jobs %}
    <div class="row">
        <div class="col-12 text-center py-5">
            <h4 class="text-muted">No completed discs found</h4>
            <p>Completed discs will appear here for batch renaming</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Batch Rename Modal -->
<div class="modal fade" id="batchRenameModal" tabindex="-1" role="dialog" aria-labelledby="batchRenameModalTitle"
     aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="batchRenameModalTitle">Batch Rename Discs</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Confirmation for non-series items -->
                <div id="rename-confirmation-step">
                    <div id="non-series-warning" class="alert alert-warning">
                        <h6><i class="fa fa-exclamation-triangle"></i> Warning: Non-TV Series Items Selected</h6>
                        <p>You have selected <strong id="non-series-count">0</strong> item(s) that are not marked as TV series.</p>
                        <p>Batch rename is optimized for TV series with disc labels (e.g., "BREAKING_BAD_S1D1"). 
                           Non-series items may not rename correctly and could use fallback naming.</p>
                        <div id="non-series-list" class="mt-2">
                            <!-- Populated by JavaScript -->
                        </div>
                        <hr>
                        <p class="mb-0"><strong>Do you want to continue with the batch rename operation?</strong></p>
                    </div>
                    <div class="text-right">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            <i class="fa fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn btn-warning" id="confirm-continue-btn">
                            <i class="fa fa-check"></i> Yes, Continue
                        </button>
                    </div>
                </div>

                <!-- Step 2: Options -->
                <div id="rename-options-step" style="display: none;">
                    <h6 class="font-weight-bold">Rename Options</h6>
                    <div class="form-group">
                        <label for="naming-style">Naming Style:</label>
                        <select id="naming-style" class="form-control">
                            <option value="underscore" selected>Underscore (Breaking_Bad_S1D1)</option>
                            <option value="hyphen">Hyphen (breaking-bad-s1d1)</option>
                            <option value="space">Space (Breaking Bad S1D1)</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="zero-padded">
                        <label class="form-check-label" for="zero-padded">
                            Zero-pad numbers (S01D01 instead of S1D1)
                        </label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="consolidate">
                        <label class="form-check-label" for="consolidate">
                            Consolidate into series parent folder (e.g., Breaking Bad (2008)/Breaking_Bad_S1D1/)
                        </label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="include-year" checked>
                        <label class="form-check-label" for="include-year">
                            Include year in series parent folder
                        </label>
                    </div>
                    <hr>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="generate-preview-btn">
                        <i class="fa fa-eye"></i> Generate Preview
                    </button>
                </div>
                
                <!-- Step 3: Series Selection and Confirmation -->
                <div id="rename-series-selection-step" style="display: none;">
                    <h6 class="font-weight-bold">Series Detection and Confirmation</h6>
                    
                    <div id="series-detection-info" class="alert alert-info">
                        <strong>Multiple series detected.</strong> Please select the primary series for this batch operation.
                    </div>
                    
                    <div id="series-groups-container">
                        <!-- Populated by JavaScript with radio buttons for each detected series -->
                    </div>
                    
                    <div class="mt-3">
                        <h6>Disc Assignment</h6>
                        <p class="text-muted small">Review which discs belong to the selected series. You can reassign outliers or skip them.</p>
                        <div id="disc-assignment-container" class="table-responsive">
                            <!-- Populated by JavaScript with disc list and assignment controls -->
                        </div>
                    </div>
                    
                    <hr>
                    <button type="button" class="btn btn-secondary" id="back-from-series-btn">
                        <i class="fa fa-arrow-left"></i> Back to Options
                    </button>
                    <button type="button" class="btn btn-primary" id="confirm-series-btn">
                        <i class="fa fa-check"></i> Confirm and Preview
                    </button>
                </div>
                
                <!-- Step 4: Preview -->
                <div id="rename-preview-step" style="display: none;">
                    <h6 class="font-weight-bold">Preview Changes</h6>
                    <div id="preview-warnings" class="alert alert-warning" style="display: none;"></div>
                    <div id="preview-outliers" class="alert alert-info" style="display: none;"></div>
                    <div id="preview-conflicts" class="alert alert-danger" style="display: none;"></div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Job ID</th>
                                    <th>Title</th>
                                    <th>Label</th>
                                    <th>Old Folder</th>
                                    <th>New Folder</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="preview-table-body">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <hr>
                    <button type="button" class="btn btn-secondary" id="back-to-options-btn">
                        <i class="fa fa-arrow-left"></i> Back to Options
                    </button>
                    <button type="button" class="btn btn-success" id="execute-rename-btn">
                        <i class="fa fa-check"></i> Execute Batch Rename
                    </button>
                </div>
                
                <!-- Step 5: Progress/Results -->
                <div id="rename-results-step" style="display: none;">
                    <h6 class="font-weight-bold">Rename Results</h6>
                    <div id="results-content"></div>
                    <hr>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" id="rollback-btn" style="display: none;">
                        <i class="fa fa-undo"></i> Rollback This Operation
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block footer %}{{ super() }}{% endblock %}

{% block js %}
    {{ super() }}
    <script type="application/javascript">activeTab("navbatchrename");</script>
    <script type="application/javascript" src="static/js/batch_rename_page.js"></script>
{% endblock %}
